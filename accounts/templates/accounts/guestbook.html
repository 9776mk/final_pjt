{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block link %}
  <style>
    .comment-bg {
      background-color: #f1f1f1;
      border-radius: 5px;
      padding: 13px 13px 5px 13px; 
      margin-top: 10px;
    }
  </style>
{% endblock link %}

{% block content %}
  <div class="container py-5 d-flex justify-content-center">
    <div class="col-sm-12 col-lg-6 col-md-8 mx-3">
      <h3 class="text-center mb-5">{{ user.profile.nickname }}ÎãòÏùò Î∞©Î™ÖÎ°ù üìú</h3>
      <!-- Î∞©Î™ÖÎ°ù Í∏Ä ÏûëÏÑ± Form -->
      <form id="gb-article-create-form" onsubmit="event.preventDefault(); create_gb_article(this, '{{ user.pk }}')">
        {% csrf_token %}
        <div class="mb-3">
          <div class="d-flex align-items-center">
            {% if not request.user.profile.image %}
              <img src="{% static 'images/no-avatar.jpg' %}" class="me-3" style="border-radius: 70%; width: 50px;" alt="">
            {% elif request.user.profile.image|slugify|slice:'0:4' == 'http' %}
              <img src="{{ request.user.profile.image }}" class="me-3" style="border-radius: 70%; width: 50px;" alt="">
            {% else %}
              <img src="{{ request.user.profile.image.url }}" class="me-3" style="border-radius: 70%; width: 50px;" alt="">
            {% endif %}

            <textarea name="content" cols="40" rows="3" wrap="hard" class="form-control me-2" placeholder="Î∞©Î™ÖÎ°ùÏùÑ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî" required id="id_content"></textarea>
            
            {% if request.user.is_authenticated %}
              <input type="submit" value="ÏûëÏÑ±" name="gb_article_create" class="btn ms-1 follow-btn-hover color-2" style="width: 80px; height: 40px; background-color: #f37c2c; color: white;">
            {% else %}
              <input type="submit" value="ÏûëÏÑ±" name="gb_article_create" class="btn ms-1 follow-btn-hover color-2" style="width: 80px; height: 40px; background-color: #f37c2c; color: white;" disabled>
            {% endif %}
          </div>
        </div>
      </form>
      <hr>
      
      <!-- Î∞©Î™ÖÎ°ù Í∏Ä Î™©Î°ù -->
      <div id="gb-articles-box" class="m-0">
        {% for article in gb_articles %}
          <div id="article-{{ article.pk }}" class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <!-- ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ 2 -->
              {% if not article.user.profile.image %}
                <div class="d-flex flex-column align-items-center">
                  <a href="{% url 'accounts:profile' article.user.pk %}"><img src="{% static 'images/no-avatar.jpg' %}" style="border-radius: 70%; width: 50px;" alt=""></a>
                  <a href="{% url 'accounts:profile' article.user.pk %}"><p class="mt-2 mb-0">{{ article.user.profile.nickname }}</p></a>
                </div>
              {% elif article.user.profile.image|slugify|slice:'0:4' == 'http' %}
                <div class="d-flex flex-column align-items-center">
                  <a href="{% url 'accounts:profile' article.user.pk %}"><img src="{{ article.user.profile.image }}" style="border-radius: 70%; width: 50px;" alt=""></a>
                  <a href="{% url 'accounts:profile' article.user.pk %}"><p class="mt-2 mb-0">{{ article.user.profile.nickname }}</p></a>
                </div>
              {% else %}
                <div class="d-flex flex-column align-items-center">
                  <a href="{% url 'accounts:profile' article.user.pk %}"><img src="{{ article.user.profile.image.url }}" style="border-radius: 70%; width: 50px;" alt=""></a>
                  <a href="{% url 'accounts:profile' article.user.pk %}"><p class="mt-2 mb-0">{{ article.user.profile.nickname }}</p></a>
                </div>
              {% endif %}

              <!-- Î∞©Î™ÖÎ°ù ÎßêÌíçÏÑ† -->
              <div class="speech-bubble w-100 ms-3">
                <!-- ÎÇ¥Ïö© & ÎÇ†Ïßú -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="me-3">{{ article.content }}</div>
                  <div style="font-size: 12px;">{{ article.created_at|date:'Y.m.d' }}</div>
                </div>

                <!-- ÎãµÍ∏Ä Îã¨Í∏∞ ÌÜ†Í∏Ä & Î∞©Î™ÖÎ°ù Í∏Ä ÏÇ≠Ï†ú Form -->
                <div class="d-flex justify-content-between align-items-center" style="font-size: 13px;">
                  <a data-bs-toggle="collapse" href="#collapse-gb-comment-form-{{ article.pk }}" class="text-center text-muted">ÎãµÍ∏Ä Îã¨Í∏∞</a>
                  
                  {% if request.user == article.user %}
                    <form id="gb-article-delete-form-{{ article.pk }}" onsubmit="event.preventDefault(); delete_gb_article(this, '{{ user.pk }}', '{{ article.pk }}')">
                      {% csrf_token %}
                      <input type="submit" class="btn-close" style="color:transparent; font:16px" onclick="return confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">
                    </form>
                  {% endif %}
                </div>
                
                <div class="collapse" id="collapse-gb-comment-form-{{ article.pk }}">
                  <!-- ÎãµÍ∏Ä ÏÉùÏÑ± Form -->
                  {% if request.user.is_authenticated %}
                    <form onsubmit="event.preventDefault(); create_gb_comment(this, '{{ user.pk }}', '{{ article.pk }}')">
                      {% csrf_token %}
                      {% comment %} <label class="form-label m-0 me-5" for="id_content">Content</label> {% endcomment %}
                      <div class="d-flex align-items-center my-2">
                        <textarea name="content" cols="40" rows="1" class="form-control me-2" placeholder="ÎãµÍ∏ÄÏùÑ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî" required id="id_content"></textarea>
                        <input type="submit" value="ÏûëÏÑ±" name="gb_comment_create" class="btn ms-1" style="width: 50px; height: 40px; background-color: #f37c2c; color: white;">
                      </div>
                    </form>
                  {% endif %}

                  <!-- ÎãµÍ∏Ä -->
                  <div id="gb-comments-box-{{ article.pk }}" class="{% if article.guestbookcomment_set.all|length != 0 %}comment-bg{% endif %}">
                    {% for comment in gb_comments %}
                      {% if comment.article == article %}
                        <div id="comment-{{ comment.pk }}" class="mb-2">
                          <div class="d-flex flex-column justify-content-between">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <div style="font-weight: bold; font-size: 15px;">
                                <!-- ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ 3 -->
                                {% if not comment.user.profile.image %}
                                  <div class="d-flex align-items-center">
                                    <a href="{% url 'accounts:profile' comment.user.pk %}"><img src="{% static 'images/no-avatar.jpg' %}" style="border-radius: 70%; width: 25px;" alt=""></a>
                                    <a href="{% url 'accounts:profile' comment.user.pk %}"><p class="ms-2 mb-0">{{ comment.user.profile.nickname }}</p></a>
                                  </div>
                                {% elif comment.user.profile.image|slugify|slice:'0:4' == 'http' %}
                                  <div class="d-flex align-items-center">
                                    <a href="{% url 'accounts:profile' comment.user.pk %}"><img src="{{ comment.user.profile.image }}" style="border-radius: 70%; width: 25px;" alt=""></a>
                                    <a href="{% url 'accounts:profile' comment.user.pk %}"><p class="ms-2 mb-0">{{ comment.user.profile.nickname }}</p></a>
                                  </div>
                                {% else %}
                                  <div class="d-flex align-items-center">
                                    <a href="{% url 'accounts:profile' comment.user.pk %}"><img src="{{ comment.user.profile.image.url }}" style="border-radius: 70%; width: 25px;" alt=""></a>
                                    <a href="{% url 'accounts:profile' comment.user.pk %}"><p class="ms-2 mb-0">{{ comment.user.profile.nickname }}</p></a>
                                  </div>
                                {% endif %}
                              </div>
                              <p class="mb-0" style="font-size: 12px;">{{ comment.created_at|date:'Y.m.d' }}</p>
                            </div>
                          </div>
                          <div class="d-flex justify-content-between">
                            <p class="mb-0">{{ comment.content }}</p>
                            <div class="d-flex align-items-end">
                              <!-- ÎãµÍ∏Ä ÏÇ≠Ï†ú Form -->
                              {% if request.user == comment.user %}
                                <form id="gb-comment-delete-form-{{ comment.pk }}" onsubmit="event.preventDefault(); delete_gb_comment(this, '{{ user.pk }}', '{{ article.pk }}', '{{ comment.pk }}')">
                                  {% csrf_token %}
                                  <input type="submit" class="btn-close" style="color:transparent; font-size: 12px;" onclick="return confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">
                                </form>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endblock content %}

{% block script %}
  <script type="text/javascript" src="{% static 'js/accounts_gb_article_async.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/accounts_gb_comment_async.js' %}"></script>
  <script>
    var str = document.getElementById("textarea").value;
    str = str.replace(/(?:\r\n|\r|\n)/g, '<br />');
    document.getElementById("text").innerHTML = str;
  </script>
{% endblock script %}